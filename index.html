<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="theme-color" content="#1A0F0E">
  <link rel="manifest" href="/Filter-kaapi/manifest.json">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FILTER KAAPI: Interactive Note-Taking App Prototype</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .filter-chip.active, .view-filter-btn.active {
            background-color: #4f46e5;
            color: #ffffff;
            border-color: #4f46e5;
        }
        .note-card {
            transition: all 0.2s ease;
        }
        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.2), 0 4px 6px -4px rgb(0 0 0 / 0.2);
        }
        .modal {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }
        .tag-input-container .tag {
            display: inline-flex;
            align-items: center;
            background-color: #312e81;
            color: #c7d2fe;
            border-radius: 9999px;
            padding: 2px 8px;
            font-size: 0.875rem;
            margin-right: 4px;
            margin-bottom: 4px;
        }
        .tag-input-container .tag button {
            margin-left: 4px;
            color: #c7d2fe;
        }
        .suggestive-tags-container .suggestive-tag-btn {
            background-color: #312e81;
            color: #c7d2fe;
            border: 1px solid #4f46e5;
            border-radius: 9999px;
            padding: 4px 12px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }
        .suggestive-tags-container .suggestive-tag-btn:hover {
            background-color: #4f46e5;
            color: #ffffff;
        }
        /* Updated style for highlighted default tags (distinct bright green color) */
        .suggestive-tags-container .suggestive-tag-btn.highlight {
            background-color: #22c55e; /* Bright Green */
            color: #ffffff;
            border-color: #16a34a; /* Slightly darker green border */
            font-weight: 600;
        }
        .suggestive-tags-container .suggestive-tag-btn.highlight:hover {
            background-color: #16a34a; /* Darker green on hover */
            border-color: #16a34a;
        }

        .note-card.dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }
        .note-card.drag-over {
            border: 2-px dashed #4f46e5;
            background-color: #1e293b;
        }
        .tag-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background-color: #1f2937;
            border-bottom: 1px solid #374151;
        }
        .tag-list-item:last-child {
            border-bottom: none;
        }

        /* Styling for the clickable 'Filters' label */
        #manage-filters-btn {
            cursor: pointer;
        }
        #manage-filters-btn:hover {
            color: #4f46e5;
        }

        /* Scroll container for filter chips */
        .filter-scroll-container {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            overflow-x: auto;
            display: flex;
            gap: 8px;
            padding: 8px 0;
        }
        .filter-scroll-container::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }

        /* Eisenhower Matrix specific styles */
        #eisenhower-matrix {
            height: calc(100vh - 200px - 64px); /* Full height minus header and footer space */
        }
        #eisenhower-matrix > div {
            min-height: 200px; /* Ensure quadrants have a minimum height */
        }
        #eisenhower-matrix .overflow-y-auto {
            flex-grow: 1;
        }

        /* Sub-task specific styles */
        .subtask-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px dashed #374151;
        }
        .subtask-item:last-child {
            border-bottom: none;
        }
        .subtask-item.completed .subtask-text {
            text-decoration: line-through;
            color: #6b7280;
        }

        /* Custom colors for header (dark coffee brown and cream) */
        .bg-dark-coffee {
            background-color: #1A0F0E; /* A very deep, dark coffee brown, now even darker */
        }
        .text-cream {
            color: #F5F5DC; /* A light, creamy color */
        }

        /* Validation Message Style */
        #validation-message {
            background-color: #ef4444; /* Red-500 */
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            text-align: center;
            font-size: 0.875rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #validation-message.show {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100">

    <div id="app" class="flex flex-col h-screen">
        <header class="bg-dark-coffee border-b border-slate-700 p-4 shadow-sm sticky top-0 z-10 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-left text-cream">FILTER KAAPI : Just note it !</h1>
            <!-- Removed theme toggle button -->
        </header>

        <main id="notes-container" class="flex-grow overflow-y-auto p-4 md:p-6 lg:p-8 pb-[200px]">
            <div id="notes-list" class="flex flex-col gap-4 max-w-2xl mx-auto">
            </div>
            <!-- Eisenhower Matrix View -->
            <div id="eisenhower-matrix" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4 max-w-4xl mx-auto">
                <div id="do-quadrant" class="bg-red-900/40 border border-red-700 rounded-lg p-4 flex flex-col">
                    <h3 class="text-lg font-bold text-red-300 mb-2">Do (Urgent & Important)</h3>
                    <div class="flex flex-col gap-2 overflow-y-auto pb-16"></div>
                </div>
                <div id="decide-quadrant" class="bg-yellow-900/40 border border-yellow-700 rounded-lg p-4 flex flex-col">
                    <h3 class="text-lg font-bold text-yellow-300 mb-2">Decide (Important & Not Urgent)</h3>
                    <div class="flex flex-col gap-2 overflow-y-auto pb-16"></div>
                </div>
                <div id="delegate-quadrant" class="bg-blue-900/40 border border-blue-700 rounded-lg p-4 flex flex-col">
                    <h3 class="text-lg font-bold text-blue-300 mb-2">Delegate (Urgent & Not Important)</h3>
                    <div class="flex flex-col gap-2 overflow-y-auto pb-16"></div>
                </div>
                <div id="discard-quadrant" class="bg-slate-700/40 border border-slate-600 rounded-lg p-4 flex flex-col">
                    <h3 class="text-lg font-bold text-slate-300 mb-2">Discard (Not Important & Not Urgent) / Undefined</h3>
                    <div class="flex flex-col gap-2 overflow-y-auto pb-16"></div>
                </div>
            </div>
        </main>

        <footer id="filter-bar" class="bg-slate-800/80 backdrop-blur-sm border-t border-slate-700 p-3 fixed bottom-0 w-full z-10">
            <div class="max-w-7xl mx-auto flex flex-col gap-4">
                <!-- View filters and Search bar on the same line -->
                <div class="flex items-center gap-2 px-2 flex-wrap">
                    <p class="text-xs font-semibold text-slate-400 whitespace-nowrap">View:</p>
                    <button id="show-all-btn" class="view-filter-btn whitespace-nowrap px-3 py-1 text-xs font-medium bg-slate-700 text-slate-200 border border-slate-600 rounded-full hover:bg-slate-600 transition-colors active">All</button>
                    <button id="show-todos-btn" class="view-filter-btn whitespace-nowrap px-3 py-1 text-xs font-medium bg-slate-700 text-slate-200 border border-slate-600 rounded-full hover:bg-slate-600 transition-colors">To-Dos</button>
                    <button id="show-notes-btn" class="view-filter-btn whitespace-nowrap px-3 py-1 text-xs font-medium bg-slate-700 text-slate-200 border border-slate-600 rounded-full hover:bg-slate-600 transition-colors">Notes</button>
                    <button id="show-priority-matrix-btn" class="view-filter-btn whitespace-nowrap px-3 py-1 text-xs font-medium bg-slate-700 text-slate-200 border border-slate-600 rounded-full hover:bg-slate-600 transition-colors">Priority Matrix</button>
                    <button id="toggle-completed-btn" class="px-3 py-1 text-xs font-medium bg-slate-700 text-slate-200 border border-slate-600 rounded-full hover:bg-slate-600 transition-colors whitespace-nowrap">Hide Completed</button>
                    <!-- Search bar relocated here -->
                    <input type="text" id="search-input" placeholder="Search notes..." class="flex-1 min-w-[120px] px-3 py-1 text-xs bg-slate-700 text-white rounded-lg border border-slate-600 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 ml-auto">
                </div>
                
                <!-- Filter chips on a separate line with horizontal scrolling -->
                <div id="tag-filter-section" class="flex items-center w-full filter-scroll-container px-2">
                    <p id="manage-filters-btn" class="text-xs font-semibold text-slate-400 whitespace-nowrap">Filters:</p>
                    <div id="filter-chips-container" class="flex items-center gap-2">
                        <!-- Filter chips will be rendered here -->
                    </div>
                </div>
            </div>
        </footer>
        
        <!-- Add Note Button -->
        <button id="add-note-btn" class="fixed bottom-[160px] right-6 bg-indigo-600 text-white rounded-full p-4 shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-110 z-20">
            <!-- Original Plus Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
        </button>
    </div>

    <!-- Note Editing Modal -->
    <div id="note-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-slate-800 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-slate-700">
                <h2 id="modal-title" class="text-xl font-bold text-white">Add New Entry</h2>
            </div>
            <div class="p-6 overflow-y-auto">
                <form id="note-form">
                    <input type="hidden" id="note-id">
                    <div class="mb-4">
                        <label for="note-title" class="block text-sm font-medium text-slate-300 mb-1">Title</label>
                        <input type="text" id="note-title" class="w-full px-3 py-2 border border-slate-600 bg-slate-700 text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div class="mb-4">
                        <label for="note-content" class="block text-sm font-medium text-slate-300 mb-1">Content</label>
                        <textarea id="note-content" rows="4" class="w-full px-3 py-2 border border-slate-600 bg-slate-700 text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    </div>
                    
                    <!-- Moved "This is a To-Do item" checkbox here -->
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="note-is-todo" class="h-4 w-4 text-indigo-600 border-slate-600 bg-slate-700 rounded focus:ring-indigo-500">
                        <label for="note-is-todo" class="ml-2 block text-sm text-slate-100">This is a To-Do item</label>
                    </div>

                    <div class="mb-4">
                        <label for="note-tags" class="block text-sm font-medium text-slate-300 mb-1">Filters</label>
                        <div class="tag-input-container border border-slate-600 rounded-md p-2 bg-slate-700">
                            <div id="tag-pills-container" class="flex flex-wrap items-center"></div>
                            <input type="text" id="note-tags-input" class="w-full focus:outline-none bg-transparent" placeholder="Add a filter and press Enter...">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-2">Available Filters</label>
                        <div id="suggestive-tags-container" class="flex flex-wrap gap-2">
                        </div>
                    </div>
                    

                    <!-- Sub-tasks Section (now always visible) -->
                    <div id="subtasks-section" class="mb-4">
                        <label class="block text-sm font-medium text-slate-300 mb-2">Sub-tasks</label>
                        <div id="subtasks-list" class="bg-slate-700 rounded-md p-3 mb-2">
                            <!-- Sub-tasks will be rendered here -->
                        </div>
                        <input type="text" id="subtask-input" class="w-full px-3 py-2 border border-slate-600 bg-slate-700 text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="Add a sub-task and press Enter...">
                    </div>
                    <!-- Validation Message Display -->
                    <div id="validation-message" class="hidden"></div>
                </form>
            </div>
            <div class="p-4 bg-slate-700 border-t border-slate-600 flex justify-end gap-3">
                <button id="cancel-btn" type="button" class="px-4 py-2 bg-slate-600 text-white text-sm font-medium rounded-md border border-slate-500 shadow-sm hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Cancel</button>
                <button id="save-btn" type="submit" form="note-form" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Save</button>
            </div>
        </div>
    </div>

    <!-- Manage Tags Modal -->
    <div id="manage-tags-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-slate-800 rounded-lg shadow-xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="p-6 border-b border-slate-700 flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">Manage Filters</h2>
                <button id="close-manage-tags-btn" class="text-slate-400 hover:text-white">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div class="mb-4">
                    <label for="new-tag-input" class="block text-sm font-medium text-slate-300 mb-1">Add a new filter</label>
                    <div class="flex gap-2">
                        <input type="text" id="new-tag-input" class="flex-grow px-3 py-2 border border-slate-600 bg-slate-700 text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" placeholder="New Filter Name">
                        <button id="add-new-tag-btn" class="px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md shadow-sm hover:bg-indigo-700">Add</button>
                    </div>
                </div>
                <div class="mt-6 border border-slate-700 rounded-md">
                    <ul id="manage-tags-list" class="divide-y divide-slate-700">
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const notesListEl = document.getElementById('notes-list');
            const filterChipsContainerEl = document.getElementById('filter-chips-container');
            const addNoteBtn = document.getElementById('add-note-btn');
            const noteModal = document.getElementById('note-modal');
            const cancelBtn = document.getElementById('cancel-btn');
            const noteForm = document.getElementById('note-form');
            const modalTitle = document.getElementById('modal-title');
            const noteIdInput = document.getElementById('note-id');
            const noteTitleInput = document.getElementById('note-title');
            const noteContentInput = document.getElementById('note-content');
            const noteIsTodoInput = document.getElementById('note-is-todo');
            const toggleCompletedBtn = document.getElementById('toggle-completed-btn');
            const manageFiltersBtn = document.getElementById('manage-filters-btn');
            const manageTagsModal = document.getElementById('manage-tags-modal');
            const closeManageTagsBtn = document.getElementById('close-manage-tags-btn');
            const manageTagsList = document.getElementById('manage-tags-list');
            const newTagInput = document.getElementById('new-tag-input');
            const addNewTagBtn = document.getElementById('add-new-tag-btn');
            const searchInput = document.getElementById('search-input');
            const showAllBtn = document.getElementById('show-all-btn');
            const showTodosBtn = document.getElementById('show-todos-btn');
            const showNotesBtn = document.getElementById('show-notes-btn');
            const showPriorityMatrixBtn = document.getElementById('show-priority-matrix-btn');
            const eisenhowerMatrixEl = document.getElementById('eisenhower-matrix');
            const tagFilterSection = document.getElementById('tag-filter-section');
            const validationMessageEl = document.getElementById('validation-message');

            let doQuadrantEl = document.querySelector('#do-quadrant > div');
            let decideQuadrantEl = document.querySelector('#decide-quadrant > div');
            let delegateQuadrantEl = document.querySelector('#delegate-quadrant > div');
            let discardQuadrantEl = document.querySelector('#discard-quadrant > div');

            const tagPillsContainer = document.getElementById('tag-pills-container');
            const tagInput = document.getElementById('note-tags-input');
            const suggestiveTagsContainer = document.getElementById('suggestive-tags-container');

            const subtasksSection = document.getElementById('subtasks-section');
            const subtasksList = document.getElementById('subtasks-list');
            const subtaskInput = document.getElementById('subtask-input');

            let expandedNotes = new Set();
            let modalSubtasks = [];

            // Define the initial protected default tags
            const PROTECTED_DEFAULT_TAGS = ['Imp', 'Urgent', 'Not Imp', 'Not Urgent'];

            // Load notes from Local Storage or use default if none exist
            let notes = JSON.parse(localStorage.getItem('notes')) || [
                { id: 1, title: 'Prepare for Marketing Presentation', content: 'Finalize slides, rehearse talking points, and ensure all team members are aligned on key messages. Focus on Q3 growth metrics.', isTodo: true, isCompleted: false, tags: ['Work', 'Presentation', 'Urgent', 'Imp'], subtasks: [{text: 'Create slide deck', isCompleted: false}, {text: 'Rehearse presentation', isCompleted: false}] },
                { id: 2, title: 'Grocery List', content: 'Milk, Eggs, Bread, Coffee, Apples, Chicken Breast. Don\'t forget the special cheese!', isTodo: true, isCompleted: false, tags: ['Personal', 'Shopping', 'Not Imp'], subtasks: [{text: 'Buy milk', isCompleted: true}, {text: 'Buy eggs', isCompleted: false}] },
                { id: 3, title: 'Meeting Notes: Project Alpha Kick-off', content: 'Key stakeholders present. Discussed project scope, initial timelines, and resource allocation. Follow-up on budget approval by Friday.', isTodo: false, isCompleted: false, tags: ['Work', 'Meeting', 'Project Alpha', 'Imp'], subtasks: [] },
                { id: 4, title: 'Call Bank about Credit Card Issue', content: 'Fraudulent charge detected. Need to dispute transaction and request new card. Call customer service during lunch break.', isTodo: true, isCompleted: false, tags: ['Personal', 'Finance', 'Urgent'], subtasks: [{text: 'Call bank', isCompleted: false}, {text: 'Dispute transaction', isCompleted: false}] },
                { id: 5, title: 'Ideas for Blog Post: Remote Work Productivity', content: 'Brainstormed topics: effective communication, setting boundaries, virtual team building, digital tools. Need to outline structure by end of week.', isTodo: false, isCompleted: false, tags: ['Work', 'Content', 'Ideas', 'Not Urgent'], subtasks: [] },
                { id: 6, title: 'Review Q2 Performance Report', content: 'Analyze sales figures, identify areas for improvement, and prepare summary for next team meeting. Pay attention to regional variances.', isTodo: true, isCompleted: false, tags: ['Work', 'Report', 'Imp'], subtasks: [{text: 'Analyze sales figures', isCompleted: false}, {text: 'Prepare summary', isCompleted: false}] },
                { id: 7, title: 'Book Dentist Appointment', content: 'It\'s been over 6 months. Need to schedule a cleaning and check-up. Call Dr. Smith\'s office next week.', isTodo: true, isCompleted: true, tags: ['Personal', 'Health', 'Not Urgent'], subtasks: [{text: 'Call Dr. Smith', isCompleted: true}, {text: 'Schedule appointment', isCompleted: true}] },
                { id: 8, title: 'Weekend Plans', content: 'Hiking trip to the national park. Check weather forecast. Pack light snacks and water. Invite Sarah and Tom.', isTodo: false, isCompleted: false, tags: ['Personal', 'Leisure', 'Planning'], subtasks: [] },
                { id: 9, title: 'Research new software for project management', content: 'Look into Asana, Trello, and Monday.com. Compare features, pricing, and team collaboration tools. Prepare a brief comparison document.', isTodo: true, isCompleted: false, tags: ['Work', 'Research', 'Tooling', 'Not Imp'], subtasks: [{text: 'Research Asana', isCompleted: false}, {text: 'Compare features', isCompleted: false}] },
                { id: 10, title: 'Learn new recipe: Vegan Chili', content: 'Found a great recipe online. Need to buy ingredients: kidney beans, black beans, tomatoes, chili powder, cumin, bell peppers. Try cooking it on Sunday.', isTodo: true, isCompleted: false, tags: ['Personal', 'Cooking', 'Hobby'], subtasks: [{text: 'Find recipe', isCompleted: true}, {text: 'Buy ingredients', isCompleted: false}] }
            ];

            // Load default tags from Local Storage or ensure protected tags are present
            let defaultTags = JSON.parse(localStorage.getItem('defaultTags')) || [];
            // Ensure protected tags are always in defaultTags
            PROTECTED_DEFAULT_TAGS.forEach(tag => {
                if (!defaultTags.includes(tag)) {
                    defaultTags.push(tag);
                }
            });

            let allTags = new Set(defaultTags);
            let selectedFilters = new Set();
            let currentEditTags = new Set();
            let draggedItem = null;
            let showCompleted = true;
            let currentView = 'all';

            // Function to save notes to Local Storage
            const saveNotes = () => {
                localStorage.setItem('notes', JSON.stringify(notes));
            };

            // Function to save allTags to Local Storage
            const saveAllTags = () => {
                localStorage.setItem('defaultTags', JSON.stringify(Array.from(defaultTags)));
            };

            const updateAllTags = () => {
                const newAllTags = new Set(defaultTags);
                notes.forEach(note => note.tags.forEach(tag => newAllTags.add(tag)));
                allTags = newAllTags;
                saveAllTags(); // Save tags after updating
            };

            const renderTags = () => {
                filterChipsContainerEl.innerHTML = '';
                allTags.forEach(tag => {
                    const chip = document.createElement('button');
                    chip.textContent = tag;
                    chip.dataset.tag = tag;
                    chip.className = `filter-chip whitespace-nowrap px-3 py-1 text-sm font-medium border rounded-full transition-colors duration-200 ${selectedFilters.has(tag) ? 'active' : 'bg-slate-700 text-slate-200 border-slate-600 hover:bg-slate-600'}`;
                    chip.onclick = () => toggleFilter(tag);
                    filterChipsContainerEl.appendChild(chip);
                });
            };

            // Function to display validation message
            const displayValidationMessage = (message) => {
                validationMessageEl.textContent = message;
                validationMessageEl.classList.remove('hidden');
                validationMessageEl.classList.add('show');
                setTimeout(() => {
                    validationMessageEl.classList.remove('show');
                    validationMessageEl.classList.add('hidden');
                }, 3000); // Hide after 3 seconds
            };


            window.toggleTodoStatus = (id) => {
                const note = notes.find(n => n.id === id);
                if (note) {
                    note.isCompleted = !note.isCompleted;
                    saveNotes(); // Save notes after status change
                    renderApp();
                }
            };

            window.toggleContent = (event, id) => {
                const contentEl = document.getElementById(`content-${id}`);
                const toggleBtn = document.getElementById(`toggle-btn-${id}`);
                // Only toggle content if the click wasn't on the checkbox itself or action buttons
                if (event.target.tagName !== 'INPUT' && event.target.tagName !== 'BUTTON' && event.target.closest('button') === null) {
                    contentEl.classList.toggle('hidden');
                    if (contentEl.classList.contains('hidden')) {
                        toggleBtn.querySelector('svg').style.transform = 'rotate(0deg)';
                        expandedNotes.delete(id); // Remove from expanded set
                    } else {
                        toggleBtn.querySelector('svg').style.transform = 'rotate(180deg)';
                        expandedNotes.add(id); // Add to expanded set
                    }
                }
            };

            window.deleteNote = (id) => {
                notes = notes.filter(n => n.id !== id);
                saveNotes(); // Save notes after deletion
                updateAllTags();
                renderApp();
                renderTags();
            };

            // Sub-task functions
            window.toggleSubtaskStatus = (noteIdFromRender, subtaskIndex) => {
                // If noteIdFromRender is null or an empty string, it's a new entry being edited in the modal
                if (noteIdFromRender === null || noteIdFromRender === '') {
                    modalSubtasks[subtaskIndex].isCompleted = !modalSubtasks[subtaskIndex].isCompleted;
                    renderSubtasks(modalSubtasks, ''); // Re-render modal subtasks, consistently pass '' for new
                } else { // Existing note context
                    // Since modalSubtasks is a reference to noteToModify.subtasks,
                    // modifying modalSubtasks directly updates the original note.
                    modalSubtasks[subtaskIndex].isCompleted = !modalSubtasks[subtaskIndex].isCompleted;
                    saveNotes(); // Save the change to local storage
                    renderSubtasks(modalSubtasks, noteIdFromRender); // Re-render modal subtasks
                }
            };

            window.deleteSubtask = (noteIdFromRender, subtaskIndex) => {
                // If noteIdFromRender is null or an empty string, it's a new entry being edited in the modal
                if (noteIdFromRender === null || noteIdFromRender === '') {
                    modalSubtasks.splice(subtaskIndex, 1);
                    renderSubtasks(modalSubtasks, ''); // Re-render modal subtasks
                } else { // Existing note context
                    // Since modalSubtasks is a reference to noteToModify.subtasks,
                    // modifying modalSubtasks directly updates the original note.
                    modalSubtasks.splice(subtaskIndex, 1);
                    saveNotes(); // Save the change to local storage
                    renderSubtasks(modalSubtasks, noteIdFromRender); // Re-render modal subtasks
                }
            };


            const toggleFilter = (tag) => {
                if (selectedFilters.has(tag)) {
                    selectedFilters.delete(tag);
                } else {
                    selectedFilters.add(tag);
                }
                document.querySelectorAll('.filter-chip').forEach(chip => {
                    if (chip.dataset.tag === tag) {
                        chip.classList.toggle('active');
                    }
                });
                renderApp();
            };

            const renderNotesList = () => {
                notesListEl.innerHTML = ''; // Clear the notes list before rendering
                notesListEl.classList.remove('hidden');
                eisenhowerMatrixEl.classList.add('hidden');
                tagFilterSection.classList.remove('hidden');
                searchInput.classList.remove('hidden');

                const searchQuery = searchInput.value.toLowerCase();
                let filteredNotes = notes.filter(note => {
                    if (currentView === 'todos' && !note.isTodo) return false;
                    if (currentView === 'notes' && note.isTodo) return false;

                    if (selectedFilters.size > 0 && !Array.from(selectedFilters).every(filter => note.tags.includes(filter))) {
                        return false;
                    }

                    const matchesSearch = note.title.toLowerCase().includes(searchQuery) || note.content.toLowerCase().includes(searchQuery) ||
                                          (note.subtasks && note.subtasks.some(sub => sub.text.toLowerCase().includes(searchQuery)));
                    if (searchQuery && !matchesSearch) {
                        return false;
                    }

                    if (!showCompleted && note.isTodo && note.isCompleted) {
                        return false;
                    }

                    return true;
                });

                filteredNotes.sort((a, b) => {
                    if (!a.isTodo && !b.isTodo) return 0;
                    if (a.isTodo && b.isTodo) return a.isCompleted - b.isCompleted;
                    if (a.isTodo) return a.isCompleted ? 1 : -1;
                    if (b.isTodo) return b.isCompleted ? -1 : 1;
                    return 0;
                });

                if (filteredNotes.length === 0) {
                    notesListEl.innerHTML = `<div class="col-span-full text-center py-12">
                        <h3 class="text-lg font-semibold text-slate-300">No entries found</h3>
                        <p class="text-slate-500 mt-1">Try adjusting your filters or adding a new entry.</p>
                    </div>`;
                } else {
                    filteredNotes.forEach(note => {
                        const card = document.createElement('div');
                        card.className = `note-card bg-slate-800 rounded-lg shadow-xl border border-slate-700 p-4 flex flex-col transition-all duration-200`;

                        card.draggable = true;
                        card.dataset.noteId = note.id;

                        const isCompleted = note.isTodo && note.isCompleted;
                        const strikethroughClass = isCompleted ? 'line-through text-slate-500' : 'text-slate-100';

                        let flagIcon = '';
                        let recommendedAction = '';
                        let actionBgColorClass = '';

                        const tags = note.tags;
                        const isImp = tags.includes('Imp');
                        const isUrgent = tags.includes('Urgent');
                        const isNotImp = tags.includes('Not Imp');
                        const isNotUrgent = tags.includes('Not Urgent');

                        if (isImp && isUrgent) {
                            flagIcon = `
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500 ml-2" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6z" />
                                </svg>
                            `;
                            recommendedAction = "Just do it";
                            actionBgColorClass = "bg-red-700";
                        } else if (isImp && isNotUrgent) {
                            flagIcon = `
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500 ml-2" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6z" />
                                </svg>
                            `;
                            recommendedAction = "Schedule it";
                            actionBgColorClass = "bg-yellow-700";
                        } else if (isNotImp && isUrgent) {
                            flagIcon = `
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500 ml-2" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6z" />
                                </svg>
                            `;
                            recommendedAction = "Delegate it";
                            actionBgColorClass = "bg-blue-700";
                        } else if (isNotImp && isNotUrgent) {
                            flagIcon = `
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-500 ml-2" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14.4 6L14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6z" />
                                </svg>
                            `;
                            recommendedAction = "Avoid or Postpone it";
                            actionBgColorClass = "bg-slate-700";
                        }

                        const tagsHtml = note.tags.map(tag => `<span class="bg-indigo-600 text-white text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">${tag}</span>`).join('');

                        let subtasksHtml = '';
                        if (note.subtasks && note.subtasks.length > 0) { // Removed isTodo condition
                            subtasksHtml = `
                                <div class="mt-2 pt-2 border-t border-slate-700">
                                    <p class="text-xs font-semibold text-slate-400 mb-1">Sub-tasks:</p>
                                    <ul class="list-disc list-inside text-sm text-slate-300">
                                        ${note.subtasks.map((sub, index) => `
                                            <li class="flex items-center ${sub.isCompleted ? 'line-through text-slate-500' : ''}">
                                                <input type="checkbox" ${sub.isCompleted ? 'checked' : ''} class="mr-2 h-4 w-4 rounded border-slate-600 bg-slate-700 text-indigo-600 focus:ring-indigo-500 cursor-pointer" onclick="event.stopPropagation(); toggleSubtaskStatus(${note.id}, ${index});"/>
                                                <span>${sub.text}</span>
                                            </li>
                                        `).join('')}
                                    </ul>
                                </div>
                            `;
                        }

                        card.innerHTML = `
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="text-lg font-medium flex-1 pr-2 cursor-pointer ${strikethroughClass}" onclick="toggleContent(event, ${note.id})">${note.title}</h3>
                                <div class="flex items-center gap-2 flex-shrink-0">
                                    ${flagIcon}
                                    <button onclick="event.stopPropagation(); openModal(${note.id});" class="text-slate-400 hover:text-indigo-500 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
                                        </svg>
                                    </button>
                                    <button onclick="event.stopPropagation(); deleteNote(${note.id});" class="text-slate-400 hover:text-red-500 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                    <button id="toggle-btn-${note.id}" class="text-slate-400 hover:text-indigo-500 transition-transform">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 transform transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                    ${note.isTodo ? `
                                        <input type="checkbox" id="todo-${note.id}" ${isCompleted ? 'checked' : ''} class="h-5 w-5 rounded border-slate-600 bg-slate-700 text-indigo-600 focus:ring-indigo-500 cursor-pointer" onclick="event.stopPropagation(); toggleTodoStatus(${note.id});">
                                    ` : ''}
                                </div>
                            </div>
                            <div id="content-${note.id}" class="hidden">
                                <p class="text-slate-400 text-sm mb-4 pt-2 border-t border-slate-700 ${strikethroughClass}">${note.content}</p>
                                ${subtasksHtml}
                                <div class="flex flex-wrap items-center justify-between gap-1 mt-auto pt-2 border-t border-slate-700">
                                    <div class="flex flex-wrap gap-1">
                                        ${tagsHtml}
                                    </div>
                                    ${recommendedAction ? `
                                        <div class="text-white text-xs font-medium px-2.5 py-0.5 rounded-full ${actionBgColorClass}">
                                            ${recommendedAction}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                        notesListEl.appendChild(card);

                        // Re-expand notes that were previously expanded
                        if (expandedNotes.has(note.id)) {
                            const contentEl = document.getElementById(`content-${note.id}`);
                            const toggleBtn = document.getElementById(`toggle-btn-${note.id}`);
                            if (contentEl) contentEl.classList.remove('hidden');
                            if (toggleBtn) toggleBtn.querySelector('svg').style.transform = 'rotate(180deg)';
                        }
                    });
                }

                const blankBox = document.createElement('div');
                blankBox.className = `note-card bg-slate-800 rounded-lg shadow-xl border border-slate-700 p-4 flex flex-col justify-center items-center h-[100px] text-slate-500 italic`;
                blankBox.innerHTML = `<p>What's brewing ?</p>`;
                notesListEl.appendChild(blankBox);

                const noteCards = notesListEl.querySelectorAll('.note-card');
                noteCards.forEach(card => {
                    card.addEventListener('dragstart', (e) => {
                        draggedItem = card;
                        card.classList.add('dragging');
                        setTimeout(() => card.style.display = 'none', 0);
                    });

                    card.addEventListener('dragenter', (e) => {
                        e.preventDefault();
                        if (draggedItem !== card) {
                            card.classList.add('drag-over');
                        }
                    });

                    card.addEventListener('dragover', (e) => {
                        e.preventDefault();
                    });

                    card.addEventListener('dragleave', () => {
                        card.classList.remove('drag-over');
                    });

                    card.addEventListener('drop', (e) => {
                        e.preventDefault();
                        card.classList.remove('drag-over');

                        if (draggedItem !== card) {
                            const draggedId = parseInt(draggedItem.dataset.noteId);
                            const targetId = parseInt(card.dataset.noteId);

                            const draggedIndex = notes.findIndex(note => note.id === draggedId);
                            const targetIndex = notes.findIndex(note => note.id === targetId);

                            const [removed] = notes.splice(draggedIndex, 1);
                            notes.splice(targetIndex, 0, removed);

                            saveNotes(); // Save notes after drag-drop
                            renderApp();
                        }
                    });

                    card.addEventListener('dragend', () => {
                        draggedItem.classList.remove('dragging');
                        draggedItem.style.display = 'flex';
                        draggedItem = null;
                        notesListEl.querySelectorAll('.note-card').forEach(c => c.classList.remove('drag-over'));
                        saveNotes(); // Save notes after drag-drop
                        renderApp();
                    });
                });
            };

            const renderEisenhowerMatrix = () => {
                eisenhowerMatrixEl.innerHTML = ''; // Clear the matrix before rendering
                notesListEl.classList.add('hidden');
                eisenhowerMatrixEl.classList.remove('hidden');
                tagFilterSection.classList.add('hidden');
                searchInput.classList.add('hidden');

                const todoItems = notes.filter(note => note.isTodo && (showCompleted || !note.isCompleted));

                if (todoItems.length === 0) {
                    eisenhowerMatrixEl.innerHTML = `<div class="col-span-full text-center py-12">
                        <h3 class="text-lg font-semibold text-slate-300">No To-Do entries found for Priority Matrix</h3>
                        <p class="text-slate-500 mt-1">Add some to-dos with "Imp" or "Urgent" tags.</p>
                    </div>`;
                } else {
                    // Re-create quadrant elements if they were cleared
                    eisenhowerMatrixEl.innerHTML = `
                        <div id="do-quadrant" class="bg-red-900/40 border border-red-700 rounded-lg p-4 flex flex-col">
                            <h3 class="text-lg font-bold text-red-300 mb-2">Do (Urgent & Important)</h3>
                            <div class="flex flex-col gap-2 overflow-y-auto pb-16"></div>
                        </div>
                        <div id="decide-quadrant" class="bg-yellow-900/40 border border-yellow-700 rounded-lg p-4 flex flex-col">
                            <h3 class="text-lg font-bold text-yellow-300 mb-2">Decide (Important & Not Urgent)</h3>
                            <div class="flex flex-col gap-2 overflow-y-auto pb-16"></div>
                        </div>
                        <div id="delegate-quadrant" class="bg-blue-900/40 border border-blue-700 rounded-lg p-4 flex flex-col">
                            <h3 class="text-lg font-bold text-blue-300 mb-2">Delegate (Urgent & Not Important)</h3>
                            <div class="flex flex-col gap-2 overflow-y-auto pb-16"></div>
                        </div>
                        <div id="discard-quadrant" class="bg-slate-700/40 border border-slate-600 rounded-lg p-4 flex flex-col">
                            <h3 class="text-lg font-bold text-slate-300 mb-2">Discard (Not Important & Not Urgent) / Undefined</h3>
                            <div class="flex flex-col gap-2 overflow-y-auto pb-16"></div>
                        </div>
                    `;
                    doQuadrantEl = document.querySelector('#do-quadrant > div');
                    decideQuadrantEl = document.querySelector('#decide-quadrant > div');
                    delegateQuadrantEl = document.querySelector('#delegate-quadrant > div');
                    discardQuadrantEl = document.querySelector('#discard-quadrant > div');


                    todoItems.forEach(todo => {
                        const isImp = todo.tags.includes('Imp');
                        const isUrgent = todo.tags.includes('Urgent');
                        const isCompleted = todo.isCompleted;

                        const todoCard = document.createElement('div');
                        todoCard.className = `bg-slate-700 rounded-md p-3 text-sm flex items-center justify-between border border-slate-600 ${isCompleted ? 'line-through text-slate-500' : 'text-slate-100'}`;
                        
                        todoCard.innerHTML = `
                            <span class="flex-1">${todo.title}</span>
                            <input type="checkbox" id="todo-eisenhower-${todo.id}" ${isCompleted ? 'checked' : ''} class="h-4 w-4 rounded border-slate-500 bg-slate-600 text-indigo-600 focus:ring-indigo-500 cursor-pointer" onclick="event.stopPropagation(); toggleTodoStatus(${todo.id});">
                        `;

                        if (isImp && isUrgent) {
                            doQuadrantEl.appendChild(todoCard);
                        } else if (isImp && !isUrgent) {
                            decideQuadrantEl.appendChild(todoCard);
                        } else if (!isImp && isUrgent) {
                            delegateQuadrantEl.appendChild(todoCard);
                        } else if (!isImp && !isUrgent) {
                            discardQuadrantEl.appendChild(todoCard);
                        }
                    });

                    if (doQuadrantEl.children.length === 0) doQuadrantEl.innerHTML = '<p class="text-slate-500 italic text-center py-4">No "Do" tasks.</p>';
                    if (decideQuadrantEl.children.length === 0) decideQuadrantEl.innerHTML = '<p class="text-slate-500 italic text-center py-4">No "Decide" tasks.</p>';
                    if (delegateQuadrantEl.children.length === 0) delegateQuadrantEl.innerHTML = '<p class="text-slate-500 italic text-center py-4">No "Delegate" tasks.</p>';
                    if (discardQuadrantEl.children.length === 0) discardQuadrantEl.innerHTML = '<p class="text-slate-500 italic text-center py-4">No "Discard" tasks.</p>';
                }
            };

            const renderApp = () => {
                document.querySelectorAll('.view-filter-btn').forEach(btn => btn.classList.remove('active'));
                if (currentView === 'all') showAllBtn.classList.add('active');
                else if (currentView === 'todos') showTodosBtn.classList.add('active');
                else if (currentView === 'notes') showNotesBtn.classList.add('active');
                else if (currentView === 'priorityMatrix') showPriorityMatrixBtn.classList.add('active'); 
                
                if (currentView === 'priorityMatrix') { 
                    renderEisenhowerMatrix();
                } else {
                    renderNotesList();
                }
            };

            showAllBtn.addEventListener('click', () => {
                currentView = 'all';
                renderApp();
            });

            showTodosBtn.addEventListener('click', () => {
                currentView = 'todos';
                renderApp();
            });

            showNotesBtn.addEventListener('click', () => {
                currentView = 'notes';
                renderApp();
            });

            showPriorityMatrixBtn.addEventListener('click', () => { 
                currentView = 'priorityMatrix'; 
                renderApp();
            });

            toggleCompletedBtn.addEventListener('click', () => {
                showCompleted = !showCompleted;
                toggleCompletedBtn.textContent = showCompleted ? 'Hide Completed' : 'Show All';
                renderApp();
            });

            searchInput.addEventListener('input', renderApp);

            window.openModal = (id = null) => {
                noteForm.reset();
                currentEditTags.clear();
                subtasksList.innerHTML = ''; // Clear subtasks list
                subtaskInput.value = ''; // Clear subtask input
                validationMessageEl.classList.add('hidden'); // Hide validation message on modal open

                let currentNote = null;

                if (id) {
                    currentNote = notes.find(n => n.id === id);
                    modalTitle.textContent = 'Edit Entry';
                    noteIdInput.value = currentNote.id;
                    noteTitleInput.value = currentNote.title;
                    noteContentInput.value = currentNote.content;
                    noteIsTodoInput.checked = currentNote.isTodo;
                    currentNote.tags.forEach(tag => currentEditTags.add(tag));
                    modalSubtasks = currentNote.subtasks;
                    if (!modalSubtasks) { 
                        modalSubtasks = [];
                        currentNote.subtasks = modalSubtasks;
                    }
                    // Subtasks section is now always visible, no need to toggle hidden class here
                    renderSubtasks(modalSubtasks, currentNote.id);

                } else {
                    modalTitle.textContent = 'Add New Entry';
                    noteIdInput.value = '';
                    modalSubtasks = [];
                    // Subtasks section is now always visible, no need to toggle hidden class here
                    renderSubtasks(modalSubtasks, '');
                }
                renderTagPills();
                renderSuggestiveTags();
                noteModal.classList.remove('hidden');
            };

            const closeModal = () => {
                noteModal.classList.add('hidden');
            };

            const renderTagPills = () => {
                tagPillsContainer.innerHTML = '';
                currentEditTags.forEach(tag => {
                    const pill = document.createElement('span');
                    pill.className = 'tag';
                    pill.innerHTML = `${tag} <button type="button" data-tag="${tag}">&times;</button>`;
                    tagPillsContainer.appendChild(pill);
                });
                renderSuggestiveTags();
            };

            const renderSuggestiveTags = () => {
                suggestiveTagsContainer.innerHTML = '';
                const availableTags = new Set(allTags);
                currentEditTags.forEach(tag => availableTags.delete(tag));

                availableTags.forEach(tag => {
                    const button = document.createElement('button');
                    button.textContent = tag;
                    button.className = 'suggestive-tag-btn';
                    // Add highlight class if it's one of the protected default tags
                    if (PROTECTED_DEFAULT_TAGS.includes(tag)) {
                        button.classList.add('highlight');
                    }
                    button.type = 'button';
                    button.onclick = () => {
                        if ((tag === 'Imp' && currentEditTags.has('Not Imp')) ||
                            (tag === 'Not Imp' && currentEditTags.has('Imp')) ||
                            (tag === 'Urgent' && currentEditTags.has('Not Urgent')) ||
                            (tag === 'Not Urgent' && currentEditTags.has('Urgent'))) {
                            console.warn(`Cannot add conflicting tag: ${tag}`);
                            displayValidationMessage(`Cannot add conflicting tag: "${tag}". Remove its opposite first.`);
                            return;
                        }
                        currentEditTags.add(tag);
                        renderTagPills();
                    };
                    suggestiveTagsContainer.appendChild(button);
                });
            };

            // Render subtasks in the modal
            const renderSubtasks = (subtasks, noteId) => {
                subtasksList.innerHTML = '';
                if (subtasks.length === 0) {
                    subtasksList.innerHTML = '<p class="text-slate-500 italic">No sub-tasks yet.</p>';
                } else {
                    subtasks.forEach((subtask, index) => {
                        const subtaskEl = document.createElement('div');
                        subtaskEl.className = `subtask-item ${subtask.isCompleted ? 'completed' : ''}`;
                        subtaskEl.innerHTML = `
                            <label class="flex items-center flex-grow cursor-pointer">
                                <input type="checkbox" ${subtask.isCompleted ? 'checked' : ''} class="h-4 w-4 text-indigo-600 border-slate-600 bg-slate-700 rounded focus:ring-indigo-500 mr-2" onclick="toggleSubtaskStatus(${noteId === '' ? null : noteId}, ${index})">
                                <span class="subtask-text">${subtask.text}</span>
                            </label>
                            <button type="button" class="text-red-400 hover:text-red-600 ml-2" onclick="deleteSubtask(${noteId === '' ? null : noteId}, ${index})">&times;</button>
                        `;
                        subtasksList.appendChild(subtaskEl);
                    });
                }
            };

            // Removed noteIsTodoInput.addEventListener('change') as subtasks section is always visible
            // subtasksSection.classList.remove('hidden'); is now handled by default HTML

            subtaskInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const newSubtaskText = subtaskInput.value.trim();
                    if (newSubtaskText) {
                        modalSubtasks.push({ text: newSubtaskText, isCompleted: false });
                        subtaskInput.value = '';
                        renderSubtasks(modalSubtasks, noteIdInput.value);
                    }
                }
            });


            tagPillsContainer.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const tagToRemove = e.target.dataset.tag;
                    currentEditTags.delete(tagToRemove);
                    renderTagPills();
                }
            });

            tagInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const newTag = tagInput.value.trim();
                    if (newTag) {
                        if ((newTag === 'Imp' && currentEditTags.has('Not Imp')) ||
                            (newTag === 'Not Imp' && currentEditTags.has('Imp')) ||
                            (newTag === 'Urgent' && currentEditTags.has('Not Urgent')) ||
                            (newTag === 'Not Urgent' && currentEditTags.has('Urgent'))) {
                            displayValidationMessage(`Cannot add conflicting tag: "${newTag}". Remove its opposite first.`);
                            return;
                        }
                        currentEditTags.add(newTag);
                        tagInput.value = '';
                        renderTagPills();
                    }
                }
            });

            noteForm.addEventListener('submit', (e) => {
                e.preventDefault();

                // Validation for To-Do items requiring at least TWO priority tags
                if (noteIsTodoInput.checked) {
                    const selectedPriorityTagsCount = PROTECTED_DEFAULT_TAGS.filter(tag => currentEditTags.has(tag)).length;
                    if (selectedPriorityTagsCount < 2) {
                        displayValidationMessage('To-Do items require at least two of the "Imp", "Urgent", "Not Imp", or "Not Urgent" tags.');
                        return; // Prevent form submission
                    }
                }

                const id = noteIdInput.value;
                const existingNote = id ? notes.find(n => n.id == id) : null;

                const newNote = {
                    id: id ? parseInt(id) : Date.now(),
                    title: noteTitleInput.value,
                    content: noteContentInput.value,
                    isTodo: noteIsTodoInput.checked,
                    isCompleted: existingNote ? existingNote.isCompleted : false,
                    tags: Array.from(currentEditTags),
                    subtasks: modalSubtasks // Ensure subtasks are saved
                };

                if (id) {
                    const index = notes.findIndex(n => n.id == id);
                    notes[index] = newNote;
                } else {
                    notes.push(newNote);
                }

                saveNotes();
                updateAllTags();
                closeModal();
                renderApp();
                renderTags();
            });

            addNoteBtn.addEventListener('click', () => openModal());
            cancelBtn.addEventListener('click', closeModal);
            noteModal.addEventListener('click', (e) => {
                if (e.target === noteModal) closeModal();
            });

            // --- Manage Filters Modal Logic ---
            manageFiltersBtn.addEventListener('click', () => {
                renderManageTagsList();
                manageTagsModal.classList.remove('hidden');
            });

            closeManageTagsBtn.addEventListener('click', () => {
                manageTagsModal.classList.add('hidden');
            });

            manageTagsModal.addEventListener('click', (e) => {
                if (e.target === manageTagsModal) {
                    manageTagsModal.classList.add('hidden');
                }
            });

            addNewTagBtn.addEventListener('click', () => {
                const newTag = newTagInput.value.trim();
                if (newTag && !allTags.has(newTag)) {
                    allTags.add(newTag);
                    defaultTags.push(newTag);
                    newTagInput.value = '';
                    saveAllTags();
                    renderManageTagsList();
                    renderTags();
                }
            });

            const renderManageTagsList = () => {
                manageTagsList.innerHTML = '';
                allTags.forEach(tag => {
                    const listItem = document.createElement('li');
                    listItem.className = 'tag-list-item text-slate-100';
                    listItem.innerHTML = `
                        <span>${tag}</span>
                        ${PROTECTED_DEFAULT_TAGS.includes(tag) ? '' : `<button class="text-red-500 hover:text-red-700" data-tag="${tag}">&times;</button>`}
                    `;
                    manageTagsList.appendChild(listItem);
                });
            };

            manageTagsList.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON' && e.target.dataset.tag) {
                    const tagToDelete = e.target.dataset.tag;
                    if (PROTECTED_DEFAULT_TAGS.includes(tagToDelete)) {
                        console.warn(`Cannot delete protected default tag: ${tagToDelete}`);
                        return;
                    }

                    allTags.delete(tagToDelete);
                    defaultTags = defaultTags.filter(tag => tag !== tagToDelete);
                    notes.forEach(note => {
                        note.tags = note.tags.filter(tag => tag !== tagToDelete);
                    });
                    saveNotes();
                    saveAllTags();
                    renderManageTagsList();
                    renderTags();
                    renderApp();
                }
            });
            // --- End Manage Filters Modal Logic ---

            updateAllTags();
            renderTags();
            renderApp();
        });
    </script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/Filter-kaapi/service-worker.js')
        .then(reg => console.log('Service Worker registered:', reg))
        .catch(err => console.log('Service Worker registration failed:', err));
    });
  }
</script>

</body>
</html>
